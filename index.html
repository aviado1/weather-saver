<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Weather Saver</title>
  <style>
    html, body { height: 100%; margin: 0; background: #000; color: #fff; font-family: "Segoe UI Variable", "Segoe UI", system-ui, -apple-system, Arial, sans-serif; }

    /* Background */
    .bg { position: fixed; inset: 0; background-size: cover; background-position: center; filter: brightness(0.9); transition: background-image 0.7s ease; }
    .veil { position: fixed; inset: 0; background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.6)); }

    /* Top center cluster: clock + date + weather */
    #top {
      position: fixed; top: 24px; left: 50%; transform: translateX(-50%);
      display: flex; flex-direction: column; align-items: center; gap: 10px;
      text-align: center; pointer-events: none;
    }

    /* Clock, smaller and lighter */
    .clock {
      font-size: clamp(48px, 7vw, 112px);
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      letter-spacing: 1px;
      line-height: 1;
      text-shadow: 0 2px 16px rgba(0,0,0,0.35);
      user-select: none;
    }
    .date {
      font-size: clamp(13px, 1.8vw, 18px);
      opacity: 0.85;
      text-shadow: 0 1px 8px rgba(0,0,0,0.35);
      user-select: none;
    }

    /* Weather card */
    .weather {
      display: none; align-items: center; gap: 12px;
      padding: 10px 14px; border-radius: 14px;
      backdrop-filter: blur(8px);
      background: rgba(0,0,0,0.45);
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      min-width: 300px; max-width: 92vw;
      pointer-events: auto;
    }
    .w-icon { width: 48px; height: 48px; }
    .w-place { font-size: 16px; opacity: 0.95; }
    .w-temp { font-size: 26px; font-weight: 600; font-variant-numeric: tabular-nums; }
    .w-cond { font-size: 16px; opacity: 0.9; }
    .w-meta { font-size: 13px; opacity: 0.85; margin-top: 2px; }

    /* Controls, dark gray */
    .controls {
      position: fixed; bottom: 16px; right: 24px; display: flex; gap: 8px;
    }
    .controls input, .controls button {
      font-size: 16px; padding: 10px 12px; border-radius: 12px; border: 1px solid #333;
      background: #1f1f1f; color: #f0f0f0;
    }
    .controls input::placeholder { color: #9aa0a6; }
    .controls button { cursor: pointer; }
    .controls button:hover { background: #262626; }
    .controls button:active { background: #2e2e2e; }

    /* Footer links, bottom-right */
    .links {
      position: fixed; bottom: 64px; right: 24px;
      display: flex; gap: 12px; align-items: center;
      font-size: 14px; opacity: 0.9;
      background: rgba(0,0,0,0.35);
      padding: 6px 10px; border-radius: 12px;
      backdrop-filter: blur(6px);
    }
    .links a { color: #eaeaea; text-decoration: none; }
    .links a:hover { text-decoration: underline; opacity: 1; }
    .links .dot { opacity: 0.7; user-select: none; }

    /* Photo credit */
    .credit {
      position: fixed; bottom: 16px; left: 24px; font-size: 14px; opacity: 0.85;
      background: rgba(0,0,0,0.35); padding: 8px 10px; border-radius: 12px;
      display: none;
    }
    .link { color: #fff; }

    @media (max-width: 640px) {
      .links { bottom: 76px; right: 12px; font-size: 13px; }
    }
  </style>
</head>
<body>
  <div id="bg" class="bg"></div>
  <div class="veil"></div>

  <!-- top center cluster -->
  <div id="top">
    <div id="clock" class="clock">00:00</div>
    <div id="date" class="date"></div>

    <div id="weatherBox" class="weather" role="status" aria-live="polite">
      <img id="wIcon" class="w-icon" alt="" />
      <div>
        <div id="wPlace" class="w-place"></div>
        <div id="wTemp" class="w-temp"></div>
        <div id="wCond" class="w-cond"></div>
        <div id="wMeta" class="w-meta"></div>
      </div>
    </div>
  </div>

  <!-- footer links -->
  <nav class="links" id="footerLinks" aria-label="Footer">
    <a href="/privacy.html">Privacy</a>
    <span class="dot">•</span>
    <a href="/disclaimer.html">Disclaimer</a>
    <span class="dot">•</span>
    <a href="mailto:[CONTACT_EMAIL]">Contact</a>
  </nav>

  <!-- controls -->
  <div class="controls" aria-label="Controls">
    <input id="cityInput" type="text" placeholder="Choose a city, for example Tel Aviv" />
    <button id="applyBtn">Update</button>
    <button id="geoBtn">Use my location</button>
    <button id="fsBtn">Full screen</button>
  </div>

  <div id="credit" class="credit"></div>

  <script>
    // Elements
    const bg = document.getElementById("bg");
    const creditEl = document.getElementById("credit");
    const clockEl = document.getElementById("clock");
    const dateEl = document.getElementById("date");
    const box = document.getElementById("weatherBox");
    const wIcon = document.getElementById("wIcon");
    const wPlace = document.getElementById("wPlace");
    const wTemp = document.getElementById("wTemp");
    const wCond = document.getElementById("wCond");
    const wMeta = document.getElementById("wMeta");
    const cityInput = document.getElementById("cityInput");
    const applyBtn = document.getElementById("applyBtn");
    const geoBtn = document.getElementById("geoBtn");
    const fsBtn = document.getElementById("fsBtn");

    // State
    let photos = [];
    let photoIndex = 0;
    let currentQuery = "Tel Aviv";

    // Clock
    function pad(n) { return String(n).padStart(2, "0"); }
    function tick() {
      const now = new Date();
      clockEl.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
      dateEl.textContent = now.toLocaleDateString("en-GB", { weekday: "long", day: "2-digit", month: "2-digit", year: "numeric" });
    }
    setInterval(tick, 1000); tick();

    // API calls
    async function fetchWeatherByCity(q) {
      const r = await fetch(`/api/weather?q=${encodeURIComponent(q)}`);
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function fetchWeatherByCoords(lat, lon) {
      const r = await fetch(`/api/weather?lat=${lat}&lon=${lon}`);
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function fetchPhotos(query) {
      const r = await fetch(`/api/photos?q=${encodeURIComponent(query)} city`);
      if (!r.ok) throw new Error(await r.text());
      const data = await r.json();
      return data.photos || [];
    }

    // Background
    function setBackground(p) {
      if (!p) return;
      const img = new Image();
      img.src = p.url;
      img.onload = () => {
        bg.style.backgroundImage = `url("${p.url}")`;
        if (p.photographer && p.photographer_url) {
          creditEl.innerHTML = `Photo by <a class="link" target="_blank" rel="noopener" href="${p.photographer_url}">${p.photographer}</a>`;
          creditEl.style.display = "block";
        } else {
          creditEl.style.display = "none";
        }
      };
    }
    function rotatePhoto() {
      if (!photos.length) return;
      photoIndex = (photoIndex + 1) % photos.length;
      setBackground(photos[photoIndex]);
    }

    // Weather render
    function renderWeather(d) {
      wPlace.textContent = [d.name, d.country].filter(Boolean).join(", ");
      wTemp.textContent = `${d.temp}°C` + (d.feels_like ? ` (feels ${d.feels_like}°)` : "");
      wCond.textContent = d.condition || "";
      wMeta.textContent = `Wind ${Math.round(d.wind_speed || 0)} m/s, dir ${d.wind_deg ?? "-"}°, clouds ${d.clouds ?? 0}%`;
      if (d.icon) { wIcon.src = `https://openweathermap.org/img/wn/${d.icon}@2x.png`; wIcon.style.display = "block"; }
      else { wIcon.style.display = "none"; }
      box.style.display = "flex";
    }

    // Orchestration
    async function refreshByCity(q) {
      try {
        currentQuery = q;
        const [w, ph] = await Promise.all([fetchWeatherByCity(q), fetchPhotos(q)]);
        renderWeather(w);
        photos = ph.length ? ph : photos;
        photoIndex = 0;
        setBackground(photos[photoIndex]);
      } catch (e) { console.error(e); }
    }

    // Events
    applyBtn.addEventListener("click", () => {
      const q = cityInput.value.trim();
      if (q) refreshByCity(q);
    });

    geoBtn.addEventListener("click", () => {
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(
        async pos => {
          try {
            const w = await fetchWeatherByCoords(pos.coords.latitude, pos.coords.longitude);
            renderWeather(w);
            if (!photos.length) {
              const ph = await fetchPhotos("city skyline");
              photos = ph; photoIndex = 0; setBackground(photos[photoIndex]);
            }
          } catch (e) { console.error(e); }
        },
        err => console.warn(err.message),
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });

    fsBtn.addEventListener("click", () => {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    });

    // Start
    setInterval(rotatePhoto, 60000);
    refreshByCity(currentQuery);
  </script>
</body>
</html>
